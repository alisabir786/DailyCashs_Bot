from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
import config
from referral import add_referral


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat_id = update.effective_chat.id

    # ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
    referrer_id = None
    if context.args:
        try:
            referrer_id = int(context.args[0])
        except:
            referrer_id = None

    # ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®
    if user.id not in config.USERS:
        config.USERS[user.id] = {
            "first_name": user.first_name,
            "last_name": user.last_name,
            "username": user.username,
            "coins": 0,
            "daily_day": 0,
            "referrals": [],
            "profile_photo": None
        }

        # ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø
        if referrer_id and referrer_id != user.id:
            if referrer_id in config.USERS:
                if user.id not in config.USERS[referrer_id]["referrals"]:
                    config.USERS[referrer_id]["referrals"].append(user.id)
                    config.USERS[referrer_id]["coins"] += config.REFER_REWARD
                    config.USERS[referrer_id]["ref_bonus"] = config.USERS[referrer_id].get("ref_bonus", 0) + config.REFER_REWARD

    # Welcome ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
    welcome_text = (
        f"üëã ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã {user.first_name or '‡¶¨‡¶®‡ßç‡¶ß‡ßÅ'}!\n\n"
        "üéÆ ‡¶ó‡ßá‡¶Æ ‡¶ñ‡ßá‡¶≤‡ßá, ‡¶∏‡ßç‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡ßá, ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶Æ‡¶™‡ßç‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®!\n\n"
        "üëá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ Play ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®:"
    )

    # ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∏‡¶π ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
    await context.bot.send_photo(
        chat_id=chat_id,
        photo="https://i.ibb.co/q3RkVXLB/welcome.png",  # ‚úÖ ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ì‡ßü‡ßá‡¶≤‡¶ï‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞
        caption=welcome_text,
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ñ∂Ô∏è Play", callback_data="open_menu")]
        ])
    )
    
